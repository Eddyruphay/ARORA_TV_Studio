name: Pescador Puppeteer - Coleta de Conte√∫do

on:
  workflow_dispatch: # Permite acionamento manual

jobs:
  collect-and-process:
    permissions:
      contents: write # Permiss√£o necess√°ria para fazer commit no reposit√≥rio
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Checkout do Reposit√≥rio
        uses: actions/checkout@v4

      - name: üü¢ Configurar Ambiente Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Usando uma vers√£o LTS est√°vel

      - name: üì¶ Instalar Depend√™ncias
        working-directory: ./pescadores
        run: npm install

      - name: üé£ Executar Captura (Puppeteer)
        id: captura # Adiciona um ID √† etapa
        working-directory: ./pescadores
        env:
          TELEGRAM_SESSION_JSON: ${{ secrets.TELEGRAM_SESSION_JSON }}
        run: node captura.js

      # - name: üóÇÔ∏è Executar Processador e Catalogador
      #   working-directory: ./pescadores
      #   run: node processador.js

      - name: üöÄ Fazer commit do Cat√°logo de Conte√∫do
        if: always() # Executa sempre, mesmo que a etapa anterior falhe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'ARORA Pescador IA'
          git config --global user.email 'bot@arora.tv'
          
          echo "--- Git Status Antes do Add ---"
          git status
          
          # Adiciona os arquivos de resultado e depura√ß√£o (incluindo os de erro)
          git add pescadores/data/raw_links.json pescadores/debug_*.png pescadores/debug_*.html pescadores/debug_*.json
          
          echo "--- Git Status Depois do Add ---"
          git status
          
          echo "--- Git Diff Staged ---"
          git diff --staged
          
          # Apenas comita se houver mudan√ßas no reposit√≥rio
          if ! git diff --staged --quiet; then
            # Adapta a mensagem de commit se a execu√ß√£o anterior falhou
            if [[ ${{ steps.captura.outcome }} == 'failure' ]]; then
              git commit -m "üî• Falha na Captura: Commit de artefatos de depura√ß√£o"
            else
              git commit -m "üìö Cat√°logo: Novo conte√∫do capturado pelo Pescador Puppeteer"
            fi
            echo "--- Realizando Push... ---"
            git push https://oauth2:$GITHUB_TOKEN@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
          else
            echo "Nenhuma mudan√ßa para commitar."
          fi
